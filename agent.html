
<div class="p-8 bg-gray-100 min-h-screen font-sans">
  <div class="max-w-4xl mx-auto bg-white p-6 rounded-lg shadow-md">
    <h1 class="text-4xl font-bold text-gray-800 mb-4">业务系统演示页面</h1>
    <p class="text-gray-600 mb-4">这是您的主业务系统。智能查数助手已通过脚本嵌入到本页面，请查看右下角。</p>
 
  </div>
</div>

<script>


(function () {
    "use strict";

    // --- 1. Guard against multiple executions ---
    if (window.__NL2SQL_AGENT_LOADED__) {
        console.log("NL2SQL Agent already loaded.");
        return;
    }
    window.__NL2SQL_AGENT_LOADED__ = true;

    // --- 2. Configuration (Defaults and User Overrides) ---
    const defaultConfig = {
        webhookUrl: 'http://localhost:5678/webhook-test/57c8f04e-beee-4510-ba9b-cab0d331563d',
        position: {
            right: "30px",
            bottom: "30px",
        },
        windowSize: {
            initial: { width: "460px", height: "640px" },
            enlarged: { width: "80vw", height: "calc(100vh - 60px)" },
        },
        zIndex: {
            button: 9998,
            chat: 9999,
            modal: 10000,
        },
    };

    function deepMerge(target, source) {
        const output = { ...target };
        if (source && typeof source === "object") {
            Object.keys(source).forEach((key) => {
                if (
                    source[key] &&
                    typeof source[key] === "object" &&
                    !Array.isArray(source[key])
                ) {
                    output[key] = deepMerge(target[key], source[key]);
                } else {
                    output[key] = source[key];
                }
            });
        }
        return output;
    }
    const config = deepMerge(defaultConfig, window.NL2SQL_AGENT_CONFIG || {});

    // --- 3. Asset Definitions (HTML & CSS from agent.html) ---
    const INLINE_STYLES = `
    /* CORRECTED: The host should be a simple, non-visual container, not a positioned element. */
    :host {
        all: initial;
        /* font-family is still useful to set a default for all inner elements */
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol";
    }
    .chatbot-container { transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1); }
    .chatbot-font { font-size: 13px; }
    .ag-theme-quartz { --ag-font-size: 11px; }
    .data-card { position: relative; border: 1px solid #dee0e3; border-radius: 12px; background-color: white; overflow: hidden; }
    .data-card-header { display: flex; justify-content: space-between; align-items: center; padding: 8px 16px; background-color: #f9fafb; border-bottom: 1px solid #dee0e3; }
    .data-card-title { font-weight: 600; color: #1f2329; }
    .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background-color: rgba(0, 0, 0, 0.5); display: flex; align-items: center; justify-content: center; z-index: ${config.zIndex.modal}; opacity: 0; transition: opacity 0.3s ease; pointer-events: none; }
    .modal-overlay.visible { opacity: 1; pointer-events: auto; }
    .modal-content { background-color: white; border-radius: 8px; box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1); width: 90%; transform: scale(0.95); transition: transform 0.3s ease; }
    .modal-overlay.visible .modal-content { transform: scale(1); }
    .sql-modal-content { max-width: 600px; padding: 20px; }
    .fullscreen-modal-content { width: 95vw; height: 95vh; border-radius: 8px; display: flex; flex-direction: column; }
    .fullscreen-modal-body { overflow: hidden; flex-grow: 1; position: relative; }
    .sql-code { background-color: #f3f4f6; padding: 12px; border-radius: 4px; max-height: 400px; overflow-y: auto; white-space: pre-wrap; word-break: break-all; font-family: monospace; color: #1f2329; }
    .view-switch-button.active { background-color: #3B82F6; color: white; }
  `;


    const CHATBOT_TEMPLATE_HTML = `
    <div class="w-full h-full flex flex-col bg-white chatbot-font">
      <div class="flex-shrink-0 bg-gray-50 border-b border-gray-200 px-4 py-3 flex items-center justify-between relative">
        <div class="flex items-center"><svg class="w-5 h-5 text-blue-600 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"></path></svg>
          <h3 class="text-sm font-semibold text-gray-800">智能数据助手</h3>
        </div>
        <div class="flex items-center space-x-2">
          
          <!-- NEW: Clear Session Button -->
          <button id="chatbot-clear-button" title="清理对话" class="text-gray-400 hover:text-gray-600 p-1">
           <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4" viewBox="0 0 24 24"><!-- Icon from Lucide by Lucide Contributors - https://github.com/lucide-icons/lucide/blob/main/LICENSE --><path fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="m16 22l-1-4m4-4.01a1 1 0 0 0 1-1V12a2 2 0 0 0-2-2h-3a1 1 0 0 1-1-1V4a2 2 0 0 0-4 0v5a1 1 0 0 1-1 1H6a2 2 0 0 0-2 2v.99a1 1 0 0 0 1 1M5 14h14l1.973 6.767A1 1 0 0 1 20 22H4a1 1 0 0 1-.973-1.233zm3 8l1-4"/></svg>
            </button>
          
          <button id="chatbot-resize-button" class="text-gray-400 hover:text-gray-600 p-1">
            <svg id="icon-enlarge" class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 8V4m0 0h4M4 4l5 5m11-1V4m0 0h-4m4 0l-5 5M4 16v4m0 0h4m-4 0l5-5m11 1v4m0 0h-4m4 0l-5-5"></path></svg>
            <svg id="icon-shrink" class="w-4 h-4 hidden" width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M12 5.33309C11.2636 5.33309 10.6667 4.73616 10.6667 3.99981V1.99989C10.6667 1.63172 10.9651 1.33325 11.3333 1.33325C11.7015 1.33325 12 1.63172 12 1.99989V3.99981H14C14.3682 3.99981 14.6667 4.29827 14.6667 4.66645C14.6667 5.03462 14.3682 5.33309 14 5.33309H12ZM3.99999 10.6662C4.73637 10.6662 5.33333 11.2631 5.33333 11.9995V13.9994C5.33333 14.3676 5.03485 14.666 4.66666 14.666C4.29847 14.666 3.99999 14.3676 3.99999 13.9994V11.9995H1.99999C1.63181 11.9995 1.33333 11.701 1.33333 11.3328C1.33333 10.9647 1.63181 10.6662 1.99999 10.6662H3.99999ZM10.6667 11.9995C10.6667 11.2631 11.2636 10.6662 12 10.6662H14C14.3682 10.6662 14.6667 10.9647 14.6667 11.3328C14.6667 11.701 14.3682 11.9995 14 11.9995H12V13.9994C12 14.3676 11.7015 14.666 11.3333 14.666C10.9651 14.666 10.6667 14.3676 10.6667 13.9994V11.9995ZM5.33333 3.99981C5.33333 4.73616 4.73637 5.33309 3.99999 5.33309H1.99999C1.63181 5.33309 1.33333 5.03462 1.33333 4.66645C1.33333 4.29827 1.63181 3.99981 1.99999 3.99981H3.99999V1.99989C3.99999 1.63172 4.29847 1.33325 4.66666 1.33325C5.03485 1.33325 5.33333 1.63172 5.33333 1.99989V3.99981Z" fill="currentColor"></path></svg>
          </button>
          
          <button id="chatbot-close-button" class="text-gray-400 hover:text-gray-600 p-1"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg></button>
        </div>
      </div>
      <div id="chat-history" class="flex-1 p-4 overflow-y-auto space-y-4 bg-white"></div>
      <div class="flex-shrink-0 border-t border-gray-200 p-3 bg-white">
        <div class="flex items-center space-x-2">
          <input type="text" id="chat-input" placeholder="请输入您的问题..." class="flex-1 w-full border border-gray-300 rounded-full py-1.5 px-4 focus:outline-none focus:ring-2 focus:ring-blue-500">
          <button id="chat-send" class="p-2 rounded-full bg-blue-600 text-white hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 disabled:bg-gray-400"><svg class="w-4 h-4 transform rotate-90" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"></path></svg></button>
        </div>
      </div>
    </div>
  `;

    // --- 4. Dependency Loader ---
    function loadResource(tag, attrs) {
        return new Promise((resolve, reject) => {
            const element = document.createElement(tag);
            for (const key in attrs) {
                element[key] = attrs[key];
            }
            element.onload = () => resolve(element);
            element.onerror = () =>
                reject(
                    new Error(`Failed to load resource: ${attrs.src || attrs.href}`)
                );
            document.head.appendChild(element);
        });
    }

    // MODIFIED: CSS files are removed from here. They will be loaded into the Shadow DOM.
    const dependencies = [
        loadResource("script", {
            src: "https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js",
        }),
        loadResource("script", {
            src: "https://unpkg.com/ag-grid-community/dist/ag-grid-community.min.js",
        }),
        loadResource("script", {
            src: "https://cdn.jsdelivr.net/npm/echarts@5.5.0/dist/echarts.min.js",
        }),
    ];

    // --- 5. Main Application Logic (Ported from agent.html) ---
    function startApp() {

        // NEW: Define shadowRoot at a higher scope to be accessible by all functions
        let shadowRoot;

        // --- Ported variables and constants ---
        const myTheme = agGrid.themeQuartz.withParams({
            accentColor: "#087AD1",
            backgroundColor: "#FFFFFF",
            borderColor: "#D7E2E6",
            borderRadius: 2,
            browserColorScheme: "light",
            cellHorizontalPaddingScale: 0.7,
            chromeBackgroundColor: { ref: "backgroundColor" },
            columnBorder: false,
            fontFamily: "inherit",
            fontSize: 11,
            foregroundColor: "#555B62",
            headerBackgroundColor: "#FFFFFF",
            headerFontSize: 12,
            headerFontWeight: 400,
            headerTextColor: "#84868B",
            rowBorder: true,
            rowVerticalPaddingScale: 0.8,
            sidePanelBorder: true,
            spacing: 6,
            wrapperBorder: false,
            wrapperBorderRadius: 2,
        });

        let sessionId = crypto.randomUUID();
        let isEnlarged = false;
        let chatContainer, floatButton;
        let responseDataStore = {};

        // --- Ported functions ---
        function init() {
            createDOM();
            attachEventListeners();
            addWelcomeMessage();
            createModals();
        }

        function createDOM() {
            // NEW: Create a host element for the Shadow DOM
            const agentHost = document.createElement("div");
            agentHost.id = "nl2sql-agent-host";
            document.body.appendChild(agentHost);

            // NEW: Attach the shadow root
            shadowRoot = agentHost.attachShadow({ mode: "open" });

            // NEW: Inject all styles directly into the Shadow DOM
            const tailwindLink = document.createElement("link");
            tailwindLink.rel = "stylesheet";
            tailwindLink.href = "https://unpkg.com/tailwindcss@^2/dist/tailwind.min.css";
            shadowRoot.appendChild(tailwindLink);

            const agGridLink = document.createElement("link");
            agGridLink.rel = "stylesheet";
            agGridLink.href = "https://unpkg.com/ag-grid-community/styles/ag-theme-quartz.css";
            shadowRoot.appendChild(agGridLink);

            const styleTag = document.createElement("style");
            styleTag.textContent = INLINE_STYLES;
            shadowRoot.appendChild(styleTag);

            // Create Float Button (创建浮动按钮)
            floatButton = document.createElement("div");
            // 注：我将按钮尺寸也调整回了 64px，这样能更好地匹配原始代码中的大图标。你可以根据需要调整。
            floatButton.style.cssText = `position: fixed; right: ${config.position.right}; bottom: ${config.position.bottom}; width: 48px; height: 48px; background-color: #2563EB; border-radius: 9999px; display: flex; align-items: center; justify-content: center; cursor: pointer; box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05); transition: all 0.3s ease-in-out; transform: scale(1); opacity: 1; z-index: ${config.zIndex.button};`;

            // 已修正: SVG 的样式现在直接定义为属性，消除了对外部 CSS 文件的依赖。
            // - 移除了 `class` 属性。
            // - 添加了 `width="32"` 和 `height="32"` (对应 Tailwind 的 w-8, h-8)。
            // - 直接将描边颜色 `stroke` 设置为 "white"。
            floatButton.innerHTML = `<svg width="24" height="24" fill="none" viewBox="0 0 24 24"><path stroke="white" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"></path></svg>`;

            // MODIFIED: Append to shadowRoot instead of document.body
            shadowRoot.appendChild(floatButton);

            // Create Chat Container
            chatContainer = document.createElement("div");
            chatContainer.classList.add("chatbot-container");
            chatContainer.style.cssText = `position: fixed; right: ${config.position.right}; bottom: ${config.position.bottom}; width: ${config.windowSize.initial.width}; height: ${config.windowSize.initial.height}; border-radius: 0.5rem; box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04); overflow: hidden; transform: scale(0); opacity: 0; transform-origin: bottom right; z-index: ${config.zIndex.chat};`;
            chatContainer.innerHTML = CHATBOT_TEMPLATE_HTML;
            // MODIFIED: Append to shadowRoot instead of document.body
            shadowRoot.appendChild(chatContainer);
        }

        function attachEventListeners() {
            floatButton.addEventListener('click', () => toggleChat(true));
            chatContainer.querySelector('#chatbot-close-button').addEventListener('click', () => toggleChat(false));
            chatContainer.querySelector('#chatbot-resize-button').addEventListener('click', toggleSize);
            chatContainer.querySelector('#chat-send').addEventListener('click', sendMessage);
            chatContainer.querySelector('#chat-input').addEventListener('keydown', (e) => { if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendMessage(); } });

            // NEW: Event listener for the clear button
            chatContainer.querySelector('#chatbot-clear-button').addEventListener('click', () => {
                // 1. Clear chat history from the DOM
                const chatHistory = chatContainer.querySelector('#chat-history');
                chatHistory.innerHTML = '';

                // 2. Generate a new session ID
                sessionId = crypto.randomUUID();
                console.log("New session started:", sessionId);

                // 3. Reset the response data store
                responseDataStore = {};

                // 4. Add the welcome message again
                addWelcomeMessage();

                // 5. Focus the input field
                chatContainer.querySelector('#chat-input').focus();
            });
        }

        function sendMessage() {
            const chatInput = chatContainer.querySelector("#chat-input");
            const question = chatInput.value.trim();
            if (!question) return;
            handleUserQuery(question);
            chatInput.value = "";
        }

        function handleUserQuery(question) {
            const webhookUrl = config.webhookUrl;
            if (!webhookUrl) {
                addErrorMessage("Webhook URL 未配置。");
                return;
            }
            addUserMessage(question);
            showLoadingIndicator();
            fetch(webhookUrl, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ question, sessionId }),
            })
                .then((response) => {
                    if (!response.ok)
                        throw new Error(`HTTP error! Status: ${response.status}`);
                    return response.json();
                })
                .then(handleN8nResponse)
                .catch((error) => {
                    removeLoadingIndicator();
                    addErrorMessage(`网络或服务器错误: ${error.message}`);
                });
        }

        // The rest of the functions from agent.html's script are copied here verbatim,
        // as they don't need significant changes.

        function handleN8nResponse(data) {
            removeLoadingIndicator();
            if (data.error) addErrorMessage(data.error.message);
            else addAiResponseMessage(data);
        }
        function addWelcomeMessage() {
            appendMessage(
                `<div class="flex items-start gap-3"><span class="flex-shrink-0 inline-flex items-center justify-center h-8 w-8 rounded-full bg-blue-100 text-blue-600"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 8v8m-4-5v5m-4-2v2m-2 4h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg></span><div class="bg-gray-100 rounded-lg p-3 max-w-[80%]"><p class="text-gray-800">你好，我是您的数据助手，请问有什么可以帮您的？</p></div></div>`
            );
        }
        function addUserMessage(message) {
            const messageId = `user-msg-${crypto.randomUUID()}`;
            const html = `<div id="${messageId}" data-question="${escapeHtml(
                message
            )}" class="flex items-start gap-3 justify-end"><div class="bg-blue-600 text-white rounded-lg p-3 max-w-[80%]"><p>${escapeHtml(
                message
            )}</p></div></div>`;
            appendMessage(html);
        }

        function addAiResponseMessage(data) {
            if (data.success === false) {
                if (data.message) {
                    appendMessage(
                        `<div class="flex items-start gap-3"><span class="flex-shrink-0 inline-flex items-center justify-center h-8 w-8 rounded-full bg-blue-100 text-blue-600"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 8v8m-4-5v5m-4-2v2m-2 4h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg></span><div class="bg-gray-100 rounded-lg p-3 max-w-[80%]"><p class="text-gray-800">${escapeHtml(
                            data.message
                        )}</p></div></div>`,
                        true
                    );
                }
            } else {
                const cardId = `card-${crypto.randomUUID()}`;
                responseDataStore[cardId] = data;
                const vizConfig = parseVisualizationConfig(data);
                const hasData = data.data && data.data.length > 0;
                const isVisualizable = vizConfig && hasData;
                let contentHtml = "";
                let defaultView = "table";
                if (isVisualizable) {
                    defaultView = vizConfig.recommended_chart;
                }
                if (!hasData) {
                    contentHtml =
                        '<p class="text-gray-600 p-4">查询成功，但没有返回任何数据。</p>';
                } else if (isVisualizable) {
                    const chartDisplayStyle = defaultView !== "table" ? "block" : "none";
                    const gridDisplayStyle = defaultView === "table" ? "block" : "none";
                    contentHtml = `<div data-view="chart" class="p-2 chart-view w-full h-72 md:h-80" style="display: ${chartDisplayStyle};"></div><div data-view="grid" class="grid-view" style="display: ${gridDisplayStyle};"></div>`;
                } else {
                    contentHtml = `<div data-view="grid" class="grid-view"></div>`;
                }
                const toolsHtml = generateToolsHtml(
                    data,
                    cardId,
                    isVisualizable,
                    vizConfig
                );
                const cardHtml = `<div id="${cardId}" class="data-card"><div class="data-card-header"><span class="data-card-title">${isVisualizable ? vizConfig.title : "查询结果"
                    }</span><div class="tools flex items-center gap-2">${toolsHtml}</div></div><div class="data-card-body">${contentHtml}</div></div>`;
                const messageHtml = `<div class="flex items-start gap-3"><span class="flex-shrink-0 inline-flex items-center justify-center h-8 w-8 rounded-full bg-blue-100 text-blue-600"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 8v8m-4-5v5m-4-2v2m-2 4h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg></span><div class="w-full max-w-[85%]">${cardHtml}</div></div>`;
                appendMessage(messageHtml, true);
                if (hasData) {
                    // MODIFIED: Query from shadowRoot to find the newly created card
                    const cardElement = shadowRoot.getElementById(cardId);
                    if (isVisualizable) {
                        renderEChart(
                            cardElement.querySelector(".chart-view"),
                            data,
                            vizConfig
                        );
                        renderAgGrid(cardElement.querySelector(".grid-view"), data);
                    } else {
                        renderAgGrid(cardElement.querySelector(".grid-view"), data);
                    }
                }
            }
        }




        function renderAgGrid(gridElement, data, overrideOptions = {}) {
            if (!gridElement) return;
            if (gridElement.agGridApi) gridElement.agGridApi.destroy();
            const columnDefs = data.fields.map((field) => ({
                headerName: field,
                field: field.toLowerCase(),
                resizable: true,
                filter: true,
                sortable: true,
            }));
            const gridOptions = {
                columnDefs,
                rowData: data.data,
                domLayout: "autoHeight",
                theme: myTheme,
                enableCellTextSelection: true,
                ...overrideOptions,
            };
            gridElement.agGridApi = agGrid.createGrid(gridElement, gridOptions);
        }

        function generateToolsHtml(data, cardId, isVisualizable, vizConfig, isFullscreen = false) {
            let html = '';
            const hasData = data.data && data.data.length > 0;

            if (isVisualizable) {
                // --- 新增：定义饼图的适用条件 ---
                let isPieChartSuitable = false;

                // 条件1：后端直接返回了标准的饼图配置 (包含 y_field)
                if (vizConfig.y_field) {
                    console.log('条件1：' + isPieChartSuitable);
                    isPieChartSuitable = true;
                }
                // // 条件2：后端返回了多系列柱状图配置 (y_fields)，且系列数量不多于6个
                // else if (Array.isArray(vizConfig.y_fields) && vizConfig.y_fields.length > 0 && vizConfig.y_fields.length <= 6) {
                //     console.log('条件2：' + isPieChartSuitable);
                //     isPieChartSuitable = true;
                // }
                // 条件3：后端返回了长数据格式 (series_field)，且系列数量不多于6个
                else if (vizConfig.series_field) {
                    const seriesField = vizConfig.series_field.toLowerCase();
                    const seriesFieldIndex = data.fields.map(f => f.toLowerCase()).indexOf(seriesField);
                    if (seriesFieldIndex !== -1) {
                        const uniqueSeriesCount = new Set(data.data.map(row => row[data.fields[seriesFieldIndex]])).size;
                        if (uniqueSeriesCount > 0 && uniqueSeriesCount <= 6) {
                            console.log('条件3' + isPieChartSuitable);
                            isPieChartSuitable = true;
                        }
                    }
                }

                const chartTypes = ['bar', 'line', 'table'];
                let buttons = '';

                const seriesField = (vizConfig.series_field || (vizConfig.series && vizConfig.series.value))?.toLowerCase();
                let isMultiSeries = false;

                if (seriesField) {
                    const seriesFieldIndex = data.fields.map(f => f.toLowerCase()).indexOf(seriesField);
                    if (seriesFieldIndex !== -1) {
                        isMultiSeries = true;
                    }
                } else if (Array.isArray(vizConfig.y_fields) && vizConfig.y_fields.length > 1) {
                    isMultiSeries = true;
                }

                let defaultView = vizConfig.recommended_chart || vizConfig.type;
                // 如果默认推荐饼图，但我们判断它不合适，则切换到柱状图
                if (defaultView === 'pie' && !isPieChartSuitable) {
                    defaultView = 'column';
                }

                console.log(isPieChartSuitable);
                if (isPieChartSuitable) {
                    chartTypes.unshift('pie');
                }

                const typeSwitcherHtml = chartTypes.map(type => {
                    // --- 核心修改在这里 ---
                    // 如果图表类型是 'pie' 并且我们判断它不适用，则直接返回空字符串，不生成该按钮
                    if (type === 'pie' && !isPieChartSuitable) {
                        return '';
                    }

                    const icon = { pie: '<svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4" viewBox="0 0 24 24"><g fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10 3.2A9 9 0 1 0 20.8 14a1 1 0 0 0-1-1H13a2 2 0 0 1-2-2V4a.9.9 0 0 0-1-.8"></path><path d="M15 3.5A9 9 0 0 1 20.5 9H16a1 1 0 0 1-1-1V3.5"></path></g></svg>', bar: '<svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4" viewBox="0 0 512 512"><path d="M32 32v432a16 16 0 0 0 16 16h432" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="32"></path><rect x="96" y="224" width="80" height="192" rx="20" ry="20" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="32"></rect><rect x="240" y="176" width="80" height="240" rx="20" ry="20" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="32"></rect><rect x="383.64" y="112" width="80" height="304" rx="20" ry="20" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="32"></rect></svg>', line: '<svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4" viewBox="0 0 32 32"><path d="M4.67 28l6.39-12l7.3 6.49a2 2 0 0 0 1.7.47a2 2 0 0 0 1.42-1.07L27 10.9l-1.82-.9l-5.49 11l-7.3-6.49a2 2 0 0 0-1.68-.51a2 2 0 0 0-1.42 1L4 25V2H2v26a2 2 0 0 0 2 2h26v-2z" fill="currentColor"></path></svg>', table: '<svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4" viewBox="0 0 32 32"><path d="M8 18h4v2H8z" fill="currentColor"></path><path d="M14 18h4v2h-4z" fill="currentColor"></path><path d="M8 14h4v2H8z" fill="currentColor"></path><path d="M14 22h4v2h-4z" fill="currentColor"></path><path d="M20 14h4v2h-4z" fill="currentColor"></path><path d="M20 22h4v2h-4z" fill="currentColor"></path><path d="M27 3H5a2.002 2.002 0 0 0-2 2v22a2.002 2.002 0 0 0 2 2h22a2.002 2.002 0 0 0 2-2V5a2.002 2.002 0 0 0-2-2zm0 2v4H5V5zM5 27V11h22v16z" fill="currentColor"></path></svg>' }[type];
                    const title = { pie: '饼图', bar: '柱状图', line: '折线图', table: '表格' }[type];
                    const isActive = type === 'bar' ? defaultView === 'column' || defaultView === 'bar' : defaultView === type;
                    return `<button title="${title}" data-view-type="${type}" class="view-switch-button p-1 text-gray-500 rounded-md hover:bg-gray-200 transition-colors ${isActive ? 'active' : ''}">${icon}</button>`;
                }).join('');

                let stackSwitcherHtml = '';
                const currentActiveType = defaultView === 'column' ? 'bar' : defaultView;
                if (isMultiSeries && currentActiveType === 'bar') {
                    const isStacked = vizConfig.stack === true;
                    const stackIcon = isStacked
                        ? '<svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4" viewBox="0 0 24 24"><g fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="18" height="18" rx="2"></rect><path d="M3 12h18"></path><path d="M12 3v18"></path></g></svg>'
                        : '<svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4" viewBox="0 0 24 24"><g fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 3v18h18"></path><path d="M7 16V8h4v8H7zm6 0V4h4v12h-4z"></path></g></svg>';
                    const stackTitle = isStacked ? "切换为分组" : "切换为堆叠";
                    stackSwitcherHtml = `<button title="${stackTitle}" data-stack-toggle="true" class="stack-switch-button p-1 text-gray-500 rounded-md hover:bg-gray-200 transition-colors">${stackIcon}</button>`;
                }

                html += `<div class="flex items-center bg-gray-100 rounded-md">${typeSwitcherHtml}</div>${stackSwitcherHtml}`;
            }

            if (!isFullscreen) {
                if (isVisualizable) html += `<div class="h-4 border-l border-gray-300 mx-1"></div>`;
                try {
                    const decodedSql = atob(data.sql || '');
                    if (decodedSql) {
                        html += `<button title="查看SQL" data-sql="${escapeHtml(decodedSql)}" class="sql-button p-1 text-gray-500 rounded-md hover:bg-gray-200 transition-colors"><svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4" viewBox="0 0 32 32"><path d="M24 21V9h-2v14h8v-2h-6z" fill="currentColor"></path><path d="M18 9h-4a2 2 0 0 0-2 2v10a2 2 0 0 0 2 2h1v2a2 2 0 0 0 2 2h2v-2h-2v-2h1a2 2 0 0 0 2-2V11a2 2 0 0 0-2-2zm-4 12V11h4v10z" fill="currentColor"></path><path d="M8 23H2v-2h6v-4H4a2 2 0 0 1-2-2v-4a2 2 0 0 1 2-2h6v2H4v4h4a2 2 0 0 1 2 2v4a2 2 0 0 1-2 2z" fill="currentColor"></path></svg></button>`;
                    }
                } catch (e) { }
                if (hasData) {
                    html += `<button title="导出Excel" data-card-id="${cardId}" class="export-button p-1 text-gray-500 rounded-md hover:bg-gray-200 transition-colors"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg></button>`;
                    html += `<button title="全屏查看" data-card-id="${cardId}" class="fullscreen-button p-1 text-gray-500 rounded-md hover:bg-gray-200 transition-colors"><svg class="w-4 h-4" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M1.99999 1.33325H4.99999C5.18409 1.33325 5.33333 1.48249 5.33333 1.66659V2.33325C5.33333 2.51735 5.18409 2.66659 4.99999 2.66659H2.66666V4.99992C2.66666 5.18401 2.51742 5.33325 2.33333 5.33325H1.66666C1.48257 5.33325 1.33333 5.18401 1.33333 4.99992V1.99992C1.33333 1.63173 1.63181 1.33325 1.99999 1.33325ZM14 14.6666H11C10.8159 14.6666 10.6667 14.5173 10.6667 14.3333V13.6666C10.6667 13.4825 10.8159 13.3333 11 13.3333H13.3333V10.9999C13.3333 10.8158 13.4826 10.6666 13.6667 10.6666H14.3333C14.5174 10.6666 14.6667 10.8158 14.6667 10.9999V13.9999C14.6667 14.3681 14.3682 14.6666 14 14.6666ZM1.33333 13.9999V10.9999C1.33333 10.8158 1.48257 10.6666 1.66666 10.6666H2.33333C2.51742 10.6666 2.66666 10.8158 2.66666 10.9999V13.3333H4.99999C5.18409 13.3333 5.33333 13.4825 5.33333 13.6666V14.3333C5.33333 14.5173 5.18409 14.6666 4.99999 14.6666H1.99999C1.63181 14.6666 1.33333 14.3681 1.33333 13.9999ZM14.6667 1.99992V4.99992C14.6667 5.18401 14.5174 5.33325 14.3333 5.33325H13.6667C13.4826 5.33325 13.3333 5.18401 13.3333 4.99992V2.66659H11C10.8159 2.66659 10.6667 2.51735 10.6667 2.33325V1.66659C10.6667 1.48249 10.8159 1.33325 11 1.33325H14C14.3682 1.33325 14.6667 1.63173 14.6667 1.99992Z" fill="currentColor"></path></svg></button>`;
                }
            }
            return html;
        }




        function addErrorMessage(message) {
            appendMessage(
                `<div class="flex items-start gap-3"><span class="flex-shrink-0 inline-flex items-center justify-center h-8 w-8 rounded-full bg-red-100 text-red-600"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg></span><div class="bg-red-100 border border-red-200 rounded-lg p-3 max-w-[80%]"><p class="text-red-800 font-semibold">发生错误</p><p class="text-red-700 mt-1">${escapeHtml(
                    message
                )}</p></div></div>`,
                true
            );
        }
        function showLoadingIndicator() {
            setInputsDisabled(true);
            appendMessage(
                `<div id="loading-indicator" class="flex items-start gap-3"><span class="flex-shrink-0 inline-flex items-center justify-center h-8 w-8 rounded-full bg-blue-100 text-blue-600"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 8v8m-4-5v5m-4-2v2m-2 4h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg></span><div class="bg-gray-100 rounded-lg p-3 max-w-[80%]"><div class="flex items-center space-x-2 text-gray-600"><div class="animate-spin rounded-full h-4 w-4 border-b-2 border-blue-500"></div><span>正在思考中...</span></div></div></div>`
            );
        }

        function removeLoadingIndicator() {
            // MODIFIED: Query within shadowRoot
            const indicator = shadowRoot.querySelector("#loading-indicator");
            if (indicator) indicator.remove();
            setInputsDisabled(false);
            chatContainer.querySelector("#chat-input").focus();
        }

        function createModals() {
            const sqlModal = document.createElement("div");
            sqlModal.id = "sql-modal";
            sqlModal.className = "modal-overlay";
            sqlModal.innerHTML = `<div class="modal-content sql-modal-content"><div class="flex justify-between items-center mb-4"><h3 class="text-lg font-semibold text-gray-800">执行的 SQL 语句</h3><button class="sql-modal-close text-2xl font-light text-gray-400 hover:text-gray-600">&times;</button></div><pre class="sql-code"><code></code></pre><div class="mt-4 text-right"><button class="sql-copy-button px-4 py-2 bg-blue-600 text-white text-sm rounded hover:bg-blue-700">复制</button></div></div>`;
            // MODIFIED: Append to shadowRoot
            shadowRoot.appendChild(sqlModal);

            const fullscreenModal = document.createElement("div");
            fullscreenModal.id = "fullscreen-modal";
            fullscreenModal.className = "modal-overlay";
            fullscreenModal.innerHTML = `<div class="modal-content fullscreen-modal-content"><div class="data-card-header"><div class="flex items-center gap-4"><span class="fullscreen-title data-card-title"></span><div class="fullscreen-view-switcher flex items-center gap-2"></div></div><button class="fullscreen-modal-close text-gray-500 hover:text-gray-800 p-1"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg></button></div><div class="fullscreen-modal-body"></div></div>`;
            // MODIFIED: Append to shadowRoot
            shadowRoot.appendChild(fullscreenModal);

            [sqlModal, fullscreenModal].forEach((modal) => {
                modal.addEventListener("click", (e) => {
                    if (e.target === modal) toggleModal(modal.id, false);
                });
                modal
                    .querySelector(".modal-content")
                    .addEventListener("click", (e) => e.stopPropagation());
                modal
                    .querySelector('[class*="-modal-close"]')
                    .addEventListener("click", () => toggleModal(modal.id, false));
            });
            sqlModal
                .querySelector(".sql-copy-button")
                .addEventListener("click", (e) => {
                    const code = sqlModal.querySelector(".sql-code code").textContent;
                    navigator.clipboard.writeText(code);
                    e.target.textContent = "已复制!";
                    setTimeout(() => {
                        e.target.textContent = "复制";
                    }, 2000);
                });
        }



        function handleFullscreenEsc(e) {
            if (e.key === "Escape") toggleModal("fullscreen-modal", false);
        }



        function toggleModal(modalId, show, content = {}) {
            // MODIFIED: Query within shadowRoot
            const modal = shadowRoot.getElementById(modalId);
            if (!modal) return;

            if (show) {
                if (modalId === 'sql-modal') {
                    modal.querySelector('.sql-code code').textContent = content.sql;

                    // 每次打开模态框时，都确保复制按钮的文本是“复制”
                    const copyButton = modal.querySelector('.sql-copy-button');
                    if (copyButton) {
                        copyButton.textContent = '复制';
                    }
                } else if (modalId === 'fullscreen-modal') {
                    const data = responseDataStore[content.cardId];
                    let vizConfig = content.vizConfig || parseVisualizationConfig(data);
                    const isVisualizable = vizConfig && data.data && data.data.length > 0;

                    modal.querySelector('.fullscreen-title').textContent = isVisualizable ? vizConfig.title : '全屏查看';
                    const body = modal.querySelector('.fullscreen-modal-body');
                    const switcher = modal.querySelector('.fullscreen-view-switcher');
                    body.innerHTML = '';
                    switcher.innerHTML = '';

                    if (isVisualizable) {
                        const renderCurrentView = (newVizConfig) => {
                            switcher.innerHTML = generateToolsHtml(data, content.cardId, true, newVizConfig, true);
                            const chartContainer = body.querySelector('.chart-container') || document.createElement('div');
                            chartContainer.className = 'chart-container w-full h-full';
                            const gridContainer = body.querySelector('.grid-container') || document.createElement('div');
                            gridContainer.className = 'grid-container w-full h-full ag-theme-quartz';

                            if (!body.contains(chartContainer)) body.append(chartContainer);
                            if (!body.contains(gridContainer)) body.append(gridContainer);

                            const viewType = newVizConfig.recommended_chart;
                            if (viewType === 'table') {
                                chartContainer.style.display = 'none';
                                gridContainer.style.display = 'block';
                                renderAgGrid(gridContainer, data, { domLayout: 'normal' });
                            } else {
                                gridContainer.style.display = 'none';
                                chartContainer.style.display = 'block';
                                renderEChart(chartContainer, data, newVizConfig, true);
                            }
                        };

                        renderCurrentView({ ...vizConfig, recommended_chart: content.viewType });

                        if (!switcher.eventListenerAttached) {
                            switcher.addEventListener('click', (event) => {
                                const button = event.target.closest('button');
                                if (!button) return;

                                let currentVizConfig = parseVisualizationConfig(data);

                                const activeSwitch = switcher.querySelector('.view-switch-button.active');
                                currentVizConfig.recommended_chart = activeSwitch ? activeSwitch.dataset.viewType : content.viewType;

                                const stackButton = switcher.querySelector('.stack-switch-button');
                                const isStacked = stackButton ? stackButton.dataset.stacked === 'true' : false;
                                if (isStacked) currentVizConfig.stack = true;

                                if (button.matches('.view-switch-button')) {
                                    delete currentVizConfig.stack;
                                    renderCurrentView({ ...currentVizConfig, recommended_chart: button.dataset.viewType });
                                }

                                if (button.matches('.stack-switch-button')) {
                                    const newStackState = !isStacked;
                                    button.dataset.stacked = newStackState;
                                    renderCurrentView({ ...currentVizConfig, stack: newStackState });
                                }
                            });
                            switcher.eventListenerAttached = true;
                        }

                    } else {
                        const gridContainer = document.createElement('div');
                        gridContainer.className = 'w-full h-full ag-theme-quartz';
                        body.appendChild(gridContainer);
                        renderAgGrid(gridContainer, data, { domLayout: 'normal' });
                    }
                    // Use the main document for global keydown events
                    document.addEventListener('keydown', handleFullscreenEsc);
                }
                modal.classList.add('visible');
            } else {
                if (modalId === 'fullscreen-modal') {
                    const body = modal.querySelector('.fullscreen-modal-body');
                    const chartContainer = body.querySelector('.chart-container');
                    if (chartContainer && chartContainer.echartsInstance) chartContainer.echartsInstance.dispose();
                    if (chartContainer && chartContainer.subChartInstances) chartContainer.subChartInstances.forEach(i => i.dispose());

                    const gridElement = body.querySelector('.ag-theme-quartz');
                    if (gridElement && gridElement.agGridApi) gridElement.agGridApi.destroy();

                    const switcher = modal.querySelector('.fullscreen-view-switcher');
                    if (switcher) switcher.eventListenerAttached = false;

                    // Remove the global event listener on close
                    document.removeEventListener('keydown', handleFullscreenEsc);
                }
                modal.classList.remove('visible');
            }
        }


        function toggleChat(open) {
            if (open) {
                chatContainer.style.transform = "scale(1)";
                chatContainer.style.opacity = "1";
                floatButton.style.transform = "scale(0)";
                floatButton.style.opacity = "0";
            } else {
                chatContainer.style.transform = "scale(0)";
                chatContainer.style.opacity = "0";
                floatButton.style.transform = "scale(1)";
                floatButton.style.opacity = "1";
                if (isEnlarged) toggleSize();
            }
        }
        function toggleSize() {
            isEnlarged = !isEnlarged;
            const { initial, enlarged } = config.windowSize;
            const iconEnlarge = chatContainer.querySelector("#icon-enlarge");
            const iconShrink = chatContainer.querySelector("#icon-shrink");
            chatContainer.style.width = isEnlarged ? enlarged.width : initial.width;
            chatContainer.style.height = isEnlarged
                ? enlarged.height
                : initial.height;
            iconEnlarge.classList.toggle("hidden", isEnlarged);
            iconShrink.classList.toggle("hidden", !isEnlarged);
        }


        function appendMessage(html, showRegenerate = false) {
            const chatHistory = chatContainer.querySelector('#chat-history');
            const messageWrapper = document.createElement('div');
            messageWrapper.innerHTML = html;

            if (showRegenerate) {
                const lastUserMessageElement = Array.from(chatHistory.querySelectorAll('[data-question]')).pop();
                if (lastUserMessageElement) {
                    const regenerateButton = document.createElement('button');
                    regenerateButton.className = 'text-gray-400 hover:text-blue-600 mt-2 ml-12 p-1 rounded-full';
                    regenerateButton.title = "重新生成";
                    regenerateButton.innerHTML = `<svg class="w-4 h-4" viewBox="0 0 18 18" fill="none" xmlns="http://www.w3.org/2000/svg"><g fill="currentColor"><path d="M12.8057 13.6388C11.7701 14.4894 10.4447 15 9.00003 15C5.68632 15 3.00003 12.3137 3.00003 9C3.00003 8.69123 3.02335 8.38791 3.06833 8.0917L3.77428 8.50919C4.05573 8.67564 4.40051 8.42728 4.3318 8.10761L3.79257 5.59892C3.74659 5.385 3.52799 5.25572 3.31837 5.31849L0.860228 6.05455C0.546995 6.14835 0.495468 6.57013 0.77691 6.73657L1.6979 7.28123C1.56848 7.83317 1.50003 8.40859 1.50003 9C1.50003 13.1421 4.85789 16.5 9.00003 16.5C11.0063 16.5 12.8286 15.7122 14.1745 14.4291L12.8057 13.6388Z"></path><path d="M5.4246 4.1812C6.42315 3.43909 7.66031 3 9.00003 3C12.3137 3 15 5.68629 15 9C15 9.21238 14.989 9.42219 14.9675 9.62887L14.145 9.16094C13.8608 8.99924 13.5203 9.25334 13.5943 9.57182L14.1756 12.0711C14.2251 12.2842 14.4459 12.4098 14.6544 12.3435L17.0999 11.5663C17.4115 11.4673 17.4559 11.0447 17.1717 10.883L16.365 10.424C16.4536 9.96297 16.5 9.48691 16.5 9C16.5 4.85786 13.1422 1.5 9.00003 1.5C7.09588 1.5 5.35746 2.20961 4.03481 3.3788L5.4246 4.1812Z"></path></g></svg>`;
                    regenerateButton.onclick = () => { const questionToRegenerate = lastUserMessageElement.dataset.question; handleUserQuery(questionToRegenerate); };
                    messageWrapper.appendChild(regenerateButton);
                }
            }
            chatHistory.appendChild(messageWrapper);

            messageWrapper.querySelectorAll('.data-card').forEach(cardElement => {
                if (cardElement.dataset.eventsAttached) return;
                cardElement.dataset.eventsAttached = 'true';

                cardElement.addEventListener('click', (event) => {
                    const button = event.target.closest('button');
                    if (!button) return;

                    const data = responseDataStore[cardElement.id];
                    let vizConfig = parseVisualizationConfig(data);
                    const toolsContainer = cardElement.querySelector('.tools');
                    const chartView = cardElement.querySelector('.chart-view');
                    const gridView = cardElement.querySelector('.grid-view');

                    const reRender = (newVizConfig) => {
                        const viewType = newVizConfig.recommended_chart;
                        if (viewType === 'table') {
                            if (chartView) {
                                chartView.innerHTML = '';
                                chartView.style.display = 'none';
                            }
                            if (gridView) gridView.style.display = 'block';
                        } else {
                            if (gridView) gridView.style.display = 'none';
                            if (chartView) {
                                chartView.style.display = 'block';
                                renderEChart(chartView, data, newVizConfig);
                            }
                        }
                        if (toolsContainer) {
                            toolsContainer.innerHTML = generateToolsHtml(data, cardElement.id, true, newVizConfig);
                        }
                    };
                    if (button.matches('.view-switch-button')) {
                        // This context is safe because these buttons only appear if vizConfig exists
                        delete vizConfig.stack;
                        const newVizConfig = { ...vizConfig, recommended_chart: button.dataset.viewType };
                        reRender(newVizConfig);
                    }
                    if (button.matches('.stack-switch-button')) {
                        // This context is also safe
                        const isCurrentlyStacked = vizConfig.stack === true;
                        const currentType = cardElement.querySelector('.view-switch-button.active')?.dataset.viewType || vizConfig.type;
                        const newVizConfig = { ...vizConfig, recommended_chart: currentType, stack: !isCurrentlyStacked };
                        reRender(newVizConfig);
                    }
                    if (button.matches('.sql-button')) { event.stopPropagation(); toggleModal('sql-modal', true, { sql: button.dataset.sql }); }

                    // CORRECTED: The fullscreen button logic now safely handles cases where vizConfig is null.
                    if (button.matches('.fullscreen-button')) {
                        event.stopPropagation();
                        const activeSwitch = cardElement.querySelector('.view-switch-button.active');
                        let viewType = 'table';
                        let configForModal = {};

                        // This check is the crucial fix.
                        if (vizConfig) {
                            if (activeSwitch) {
                                viewType = activeSwitch.dataset.viewType;
                            } else {
                                viewType = vizConfig.recommended_chart || vizConfig.type;
                            }
                            // It's only safe to access .stack after confirming vizConfig exists.
                            const currentStack = vizConfig.stack === true;
                            configForModal = { ...vizConfig, stack: currentStack };
                        }

                        toggleModal('fullscreen-modal', true, {
                            cardId: cardElement.id,
                            viewType: viewType,
                            vizConfig: configForModal
                        });
                    }

                    if (button.matches('.export-button')) { event.stopPropagation(); if (data && data.data) { const exportData = data.data.map(row => { const newRow = {}; data.fields.forEach(field => { newRow[field] = row[field.toLowerCase()]; }); return newRow; }); const ws = XLSX.utils.json_to_sheet(exportData); const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, ws, "QueryResult"); XLSX.writeFile(wb, "query_result.xlsx"); } }
                });
            });

            chatHistory.scrollTop = chatHistory.scrollHeight;
        }



        function setInputsDisabled(disabled) {
            chatContainer.querySelector("#chat-input").disabled = disabled;
            chatContainer.querySelector("#chat-send").disabled = disabled;
        }
        function escapeHtml(unsafe) {
            const str = String(unsafe === null || unsafe === undefined ? "" : unsafe);
            return str
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
        }
        function parseVisualizationConfig(data) {
            if (
                !data ||
                !Array.isArray(data.visualization) ||
                data.visualization.length === 0
            )
                return null;
            try {
                return JSON.parse(data.visualization[0].json.output);
            } catch (e) {
                console.error("Failed to parse visualization config:", e);
                return null;
            }
        }


        function renderEChart(container, data, vizConfig, isFullscreen = false) {
            if (!container || !data || !vizConfig) return;

            if (container.echartsInstance) { container.echartsInstance.dispose(); }
            container.innerHTML = '';

            const lowerCaseFields = data.fields.map(f => f.toLowerCase());
            const chartTypeRaw = vizConfig.recommended_chart || vizConfig.type;
            const isBarChart = chartTypeRaw === 'bar';
            const chartType = chartTypeRaw === 'column' ? 'bar' : chartTypeRaw;

            const xField = vizConfig.x_field?.toLowerCase();
            const xFieldIndex = xField ? lowerCaseFields.indexOf(xField) : -1;

            if (xFieldIndex === -1 && chartType !== 'pie') {
                container.innerHTML = `<div class="text-red-500 p-4 text-center">图表渲染失败：找不到类别轴字段 (${vizConfig.x_field})。</div>`;
                return;
            }

            const chartTitle = isFullscreen ? '' : vizConfig.title;
            const xAxisName = vizConfig.x_name || '类别';
            const yAxisName = vizConfig.y_name || '值';

            let chartInstance = echarts.init(container);
            let option = {};

            const processValue = (val) => parseFloat(String(val).replace(/[^0-9.-]+/g, "")) || 0;

            if (chartType === 'pie') {
                // --- 饼图逻辑 ---
                const yField = vizConfig.y_field?.toLowerCase();
                const yFieldIndex = yField ? lowerCaseFields.indexOf(yField) : -1;
                if (yFieldIndex === -1) { container.innerHTML = `<div class="text-red-500 p-4 text-center">饼图渲染失败：找不到数值字段 (${vizConfig.y_field})。</div>`; return; }
                const pieData = data.data.map(row => ({
                    value: processValue(row[data.fields[yFieldIndex]]),
                    name: row[data.fields[xFieldIndex]]
                }));
                option = {
                    title: { text: chartTitle, left: 'center', textStyle: { fontSize: 16, fontWeight: 'normal' } },
                    tooltip: { trigger: 'item', formatter: '{a} <br/>{b}: {c} ({d}%)' },
                    legend: { orient: 'vertical', left: 'left', top: 'center', type: 'scroll' },
                    series: [{ name: yAxisName, type: 'pie', radius: isFullscreen ? ['40%', '70%'] : '60%', center: ['60%', '55%'], data: pieData }]
                };
            } else {
                // --- 柱状图/条形图/折线图逻辑 ---
                let seriesData = [];
                let legendData = [];
                let xAxisCategories = [];

                if (Array.isArray(vizConfig.y_fields)) { // 模式1: 宽数据
                    xAxisCategories = data.data.map(row => row[data.fields[xFieldIndex]]);
                    seriesData = vizConfig.y_fields.map(yFieldKey => {
                        const yFieldIndex = lowerCaseFields.indexOf(yFieldKey.toLowerCase());
                        if (yFieldIndex === -1) return null;
                        const seriesName = (vizConfig.series_names && vizConfig.series_names[yFieldKey]) || yFieldKey;
                        legendData.push(seriesName);
                        return {
                            name: seriesName, type: chartType, stack: vizConfig.stack ? 'total' : undefined,
                            emphasis: { focus: 'series' }, smooth: chartType === 'line',
                            data: data.data.map(row => processValue(row[data.fields[yFieldIndex]]))
                        };
                    }).filter(Boolean);
                } else if (vizConfig.series_field) { // 模式2: 长数据
                    const yField = vizConfig.y_field?.toLowerCase();
                    const yFieldIndex = yField ? lowerCaseFields.indexOf(yField) : -1;
                    const seriesField = vizConfig.series_field?.toLowerCase();
                    const seriesFieldIndex = seriesField ? lowerCaseFields.indexOf(seriesField) : -1;
                    if (yFieldIndex === -1 || seriesFieldIndex === -1) { container.innerHTML = `<div class="text-red-500 p-4 text-center">图表渲染失败：找不到数值或分组字段。</div>`; return; }

                    xAxisCategories = [...new Set(data.data.map(row => row[data.fields[xFieldIndex]]))].sort();
                    legendData = [...new Set(data.data.map(row => row[data.fields[seriesFieldIndex]]))];
                    seriesData = legendData.map(name => ({
                        name, type: chartType, stack: vizConfig.stack ? 'total' : undefined,
                        emphasis: { focus: 'series' }, smooth: chartType === 'line',
                        data: xAxisCategories.map(category => {
                            const row = data.data.find(r => r[data.fields[xFieldIndex]] === category && r[data.fields[seriesFieldIndex]] === name);
                            return row ? processValue(row[data.fields[yFieldIndex]]) : 0;
                        })
                    }));
                } else { // 模式3: 单系列
                    const yField = vizConfig.y_field?.toLowerCase();
                    const yFieldIndex = yField ? lowerCaseFields.indexOf(yField) : -1;
                    if (yFieldIndex === -1) { container.innerHTML = `<div class="text-red-500 p-4 text-center">图表渲染失败：找不到数值字段 (${vizConfig.y_field})。</div>`; return; }
                    xAxisCategories = data.data.map(row => row[data.fields[xFieldIndex]]);
                    seriesData = [{
                        name: yAxisName, type: chartType, smooth: chartType === 'line',
                        data: data.data.map(row => processValue(row[data.fields[yFieldIndex]]))
                    }];
                }

                const baseOption = {
                    title: { text: chartTitle, left: 'center', textStyle: { fontSize: 16, fontWeight: 'normal' } },
                    tooltip: { trigger: 'axis', axisPointer: { type: 'shadow' } },
                    legend: { data: legendData, top: 30, type: 'scroll' },
                    grid: { left: '3%', right: '4%', bottom: '3%', containLabel: true, top: legendData.length > 0 ? 60 : 40 },
                    series: seriesData,
                    dataZoom: [{ type: 'inside' }, { show: isFullscreen && xAxisCategories.length > 15 }]
                };

                if (isBarChart) {
                    option = { ...baseOption, xAxis: { type: 'value', name: yAxisName }, yAxis: { type: 'category', data: xAxisCategories, name: xAxisName, axisLabel: { interval: 0 } } };
                } else {
                    option = { ...baseOption, xAxis: { type: 'category', data: xAxisCategories, name: xAxisName, axisLabel: { interval: 0, rotate: xAxisCategories.length > 8 ? 30 : 0 } }, yAxis: { type: 'value', name: yAxisName } };
                }
            }

            if (Object.keys(option).length > 0) {
                chartInstance.setOption(option, true);
                container.echartsInstance = chartInstance;
            }

            if (!container.resizeObserver) {
                container.resizeObserver = new ResizeObserver(() => {
                    if (container.echartsInstance && !container.echartsInstance.isDisposed()) {
                        container.echartsInstance.resize();
                    }
                });
                container.resizeObserver.observe(container);
            }
        }



        // NEW HELPER FUNCTION
        function bindCardControlEvents(cardElement) {
            const reRenderChart = (newConfig) => {
                const data = responseDataStore[cardElement.id];
                const chartView = cardElement.querySelector('.chart-view');
                // 核心：重新渲染图表和工具栏
                renderEChart(chartView, data, newConfig);
                const toolsContainer = cardElement.querySelector('.tools');
                if (toolsContainer) {
                    toolsContainer.innerHTML = generateToolsHtml(data, cardElement.id, true, newConfig);
                    // 关键一步：为新生成的按钮重新绑定事件！
                    bindCardControlEvents(cardElement);
                }
            };

            // 绑定图表类型切换按钮
            cardElement.querySelectorAll('.view-switch-button').forEach(button => {
                button.onclick = () => {
                    const viewType = button.dataset.viewType;
                    const gridView = cardElement.querySelector('.grid-view');
                    const chartView = cardElement.querySelector('.chart-view');
                    const data = responseDataStore[cardElement.id];
                    let vizConfig = parseVisualizationConfig(data);

                    if (viewType === 'table') {
                        if (chartView) chartView.style.display = 'none';
                        if (gridView) gridView.style.display = 'block';
                        // 重新生成工具栏以更新状态
                        const toolsContainer = cardElement.querySelector('.tools');
                        if (toolsContainer) {
                            toolsContainer.innerHTML = generateToolsHtml(data, cardElement.id, true, { ...vizConfig, recommended_chart: 'table' });
                            bindCardControlEvents(cardElement);
                        }
                    } else {
                        if (gridView) gridView.style.display = 'none';
                        if (chartView) {
                            chartView.style.display = 'block';
                            // 切换时，重置stack状态
                            delete vizConfig.stack;
                            const newVizConfig = { ...vizConfig, recommended_chart: viewType };
                            reRenderChart(newVizConfig);
                        }
                    }
                };
            });

            // 绑定堆叠/分组切换按钮
            cardElement.querySelectorAll('.stack-switch-button').forEach(button => {
                button.onclick = () => {
                    const data = responseDataStore[cardElement.id];
                    let vizConfig = parseVisualizationConfig(data);
                    const isCurrentlyStacked = vizConfig.stack === true;
                    // 保持当前图表类型，只切换stack状态
                    const currentType = cardElement.querySelector('.view-switch-button.active')?.dataset.viewType || vizConfig.type;
                    const newVizConfig = { ...vizConfig, recommended_chart: currentType, stack: !isCurrentlyStacked };
                    reRenderChart(newVizConfig);
                };
            });

            // 绑定其他按钮 (SQL, 全屏, 导出)
            cardElement.querySelectorAll('.sql-button').forEach(button => { button.onclick = (e) => { e.stopPropagation(); toggleModal('sql-modal', true, { sql: button.dataset.sql }); }; });
            cardElement.querySelectorAll('.fullscreen-button').forEach(button => { button.onclick = (e) => { e.stopPropagation(); const activeSwitch = cardElement.querySelector('.view-switch-button.active'); let viewType = 'table'; if (activeSwitch) { viewType = activeSwitch.dataset.viewType; } else { const vizConfig = parseVisualizationConfig(responseDataStore[cardElement.id]); if (vizConfig) viewType = vizConfig.recommended_chart || vizConfig.type; } toggleModal('fullscreen-modal', true, { cardId: cardElement.id, viewType: viewType }); }; });
            cardElement.querySelectorAll('.export-button').forEach(button => { button.onclick = (e) => { e.stopPropagation(); const cardId = button.dataset.cardId; const data = responseDataStore[cardId]; if (data && data.data) { const exportData = data.data.map(row => { const newRow = {}; data.fields.forEach(field => { newRow[field] = row[field.toLowerCase()]; }); return newRow; }); const ws = XLSX.utils.json_to_sheet(exportData); const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, ws, "QueryResult"); XLSX.writeFile(wb, "query_result.xlsx"); } }; });
        }



        // Start the application logic
        init();
    }

    // --- 6. Bootstrapping ---
    // Wait for all external scripts and styles to load, then start the app.
    Promise.all(dependencies)
        .then(startApp)
        .catch((error) => {
            console.error("Failed to load NL2SQL Agent dependencies:", error);
            // Optionally, show an error message to the user on the page
            const errorDiv = document.createElement("div");
            errorDiv.style.cssText =
                "position:fixed;bottom:10px;left:10px;padding:15px;background-color:#ff4d4d;color:white;border-radius:8px;z-index:10000;font-family:sans-serif;";
            errorDiv.textContent = "智能助手加载失败，请检查网络连接或联系管理员。";
            document.body.appendChild(errorDiv);
        });
})();

</script>

